import nmap
import requests
from bs4 import BeautifulSoup
from lxml import html
import wget

def ip_scanner():
    nm = nmap.PortScanner()
    nm.scan(hosts='192.168.0.0/24', arguments='-A -T4 -p 80')

    return nm.all_hosts()

def find_hello_cgi(ip):
    r = requests.get('http://' + ip + '/cgi-bin/hello.cgi')
    return r.status_code

def list_days(ip):
    r = requests.get('http://' + ip + '/cgi-bin/hello.cgi?name=record')
    soup = BeautifulSoup(r.text, 'html.parser')
    days = soup.find_all('h2')
    return [x.get_text() for x in days]

def list_hours(day, ip):

    r = requests.get('http://'+ ip + '/cgi-bin/hello.cgi?name=record/'+day)
    soup = BeautifulSoup(r.text, 'html.parser')
    hours = soup.find_all('h2')
    return [x.get_text() for x in hours]

def list_videos(day, hour, ip):
    r = requests.get('http://' + ip + '/cgi-bin/hello.cgi?name=record/'+day+'/'+hour)
    soup = BeautifulSoup(r.text, 'html.parser')
    videos = soup.find_all('h1')
    return [x.get_text() for x in videos]

def get_video(day, hour, vid, ip):

    print("\ndownloading most recent minute of recording...\n")
    r = wget.download('http://' + ip + '/SDPath/record/'+day+'/'+hour+'/'+vid)
    print("\nname of file: ", r)

if __name__ == "__main__":
    hosts = ip_scanner()
    camera = ''
    for host in hosts:
        try:
            response = find_hello_cgi(host)
            if str(response) == '200':
                print ('Wyze Camera has IP: ' + host)
                camera = host
                break
        except:
                pass
    if camera == '':
        print('no IPs found')
    else:
        days = list_days(camera)

        hours = list_hours(days[-1], camera)
    
        videos = []
        for hour in hours:
            videos.append((hour,list_videos(days[-1], hour, camera)))
    
        get_video(days[-1],videos[-1][0], videos[-1][1][-2], camera)
