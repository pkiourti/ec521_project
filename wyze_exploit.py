#!/usr/bin/env python3



import subprocess
import os
import nmap
import requests
from bs4 import BeautifulSoup
import pycurl
from lxml import html
import wget



def ip_scanner():
    nm = nmap.PortScanner()
    nm.scan(hosts='192.168.0.0/24', arguments='-A -T4 -p 80')

    print (nm.all_hosts())
    
    return nm.all_hosts()


def find_hello_cgi(host):
    r = requests.get('http://'+host+'/cgi-bin/hello.cgi')
    return r.status_code
    

def list_days():
    r = requests.get('http://192.168.0.201/cgi-bin/hello.cgi?name=record')
    print (r.text)
    soup = BeautifulSoup(r.text, 'html.parser')
    days = soup.find_all('h2')
    return [x.get_text() for x in days]

def list_hours(day):

    r = requests.get('http://192.168.0.201/cgi-bin/hello.cgi?name=record/'+day)
    soup = BeautifulSoup(r.text, 'html.parser')
    hours = soup.find_all('h2')
    return [x.get_text() for x in hours]

def list_videos(day, hour):
    r = requests.get('http://192.168.0.201/cgi-bin/hello.cgi?name=record/'+day+'/'+hour)
    soup = BeautifulSoup(r.text, 'html.parser')
    videos = soup.find_all('h1')
    return [x.get_text() for x in videos]

def get_video(day,hour,vid):

   # print ('http://192.168.0.201/SDPath/record/'+day+'/'+hour+'/'+vid)
    r = wget.download('http://192.168.0.201/SDPath/record/'+day+'/'+hour+'/'+vid)
    #subprocess.run(['vlc', 'vid'])


if __name__ == "__main__":
    
 #   hosts = ip_scanner()
    #create effects
   # for host in hosts:
    #    response = find_hello_cgi(host)
     #   if str(response) == '200':
      #      print ('Wyze Camera has IP: ' + host)
       #     camera = host
        #    break
    days = list_days()
    print (days)

    hours = list_hours(days[-1])
    print (hours)
    
    videos = []
    for hour in hours:
        videos.append((hour,list_videos(days[-1],hour)))
    
    print (videos)

    get_video(days[-1],videos[-1][0], videos[-1][1][-2])
    
    
